name: "CodeQL"

on:
  workflow_call:
    inputs:
      supported_languages:
        description: 'Comma-separated list of supported languages'
        type: string
        required: true
        default: 'go,python,javascript-typescript'

jobs:
  detect-languages:
    runs-on: ubuntu-24.04
    outputs:
      matched_matrix: ${{ steps.set-matrix.outputs.matched_matrix }}
      should_scan: ${{ steps.set-matrix.outputs.should_scan }}
    steps:      
      - name: Filter to supported languages
        id: set-matrix
        run: |
          IFS=',' read -r -a supported <<< "${{ inputs.supported_languages }}"

          matched=()
          for lang in "${supported[@]}"; do
            lang_trimmed=$(echo "$lang" | xargs | tr '[:upper:]' '[:lower:]')
            if echo "$repo_langs" | grep -iq "\"$lang_trimmed\""; then
              matched+=("\"$lang_trimmed\"")
            fi
          done

          if [ ${#matched[@]} -gt 0 ]; then
            matrix_json="{\"language\":[${matched[*]}]}"
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "matched_matrix=$matrix_json" >> $GITHUB_OUTPUT
          else
            echo "should_scan=false" >> $GITHUB_OUTPUT
            echo "matched_matrix={\"language\":[]}" >> $GITHUB_OUTPUT
          fi

          
  analyze:
    needs: detect-languages
    if: needs.detect-languages.outputs.should_scan == 'true'
    name: Analyze (${{ matrix.language }})
    permissions:
      packages: read
      actions: read # for github/codeql-action/init to get workflow details
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/autobuild to send a status report
    strategy:
      matrix: ${{ fromJson(needs.detect-languages.outputs.matched_matrix) }}
    runs-on: ubuntu-24.04    
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL      
        uses: github/codeql-action/init@60168efe1c415ce0f5521ea06d5c2062adbeed1b # v3.28.17
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
    
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@60168efe1c415ce0f5521ea06d5c2062adbeed1b # v3.28.17        
        with:
          category: "/language:${{matrix.language}}"
          